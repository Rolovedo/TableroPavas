// Servicio para gesti√≥n de notificaciones WhatsApp
import { logger } from '../../../common/utils/logger.js';
import { pool } from '../../../common/configs/database.config.js';

class WhatsAppNotificationService {

    /**
     * Enviar notificaci√≥n por WhatsApp
     */
    async sendNotification(data) {
        try {
            const {
                phone,
                message,
                taskId = null,
                changeRequestId = null,
                type = 'general'
            } = data;

            // Registrar la notificaci√≥n en la base de datos
            const notificationId = await this.saveNotification({
                taskId,
                changeRequestId,
                recipientPhone: phone,
                message,
                type
            });

            // Aqu√≠ se integrar√≠a con el servicio real de WhatsApp
            // Por ahora simulamos el env√≠o
            const success = await this.sendWhatsAppMessage(phone, message);

            // Actualizar el estado de la notificaci√≥n
            await this.updateNotificationStatus(notificationId, success ? 'sent' : 'failed');

            if (success) {
                logger.info(`Notificaci√≥n WhatsApp enviada a ${phone}`);
            } else {
                logger.error(`Error enviando notificaci√≥n WhatsApp a ${phone}`);
            }

            return { success, notificationId };

        } catch (error) {
            logger.error('Error en servicio de notificaci√≥n WhatsApp:', error);
            throw error;
        }
    }

    /**
     * Enviar notificaci√≥n de solicitud de cambio de tarea
     */
    async sendTaskChangeRequestNotification(changeRequest) {
        try {
            // Obtener tel√©fono del supervisor desde configuraci√≥n
            const supervisorPhone = await this.getSupervisorPhone();
            
            if (!supervisorPhone) {
                throw new Error('No se encontr√≥ tel√©fono del supervisor configurado');
            }

            // Obtener informaci√≥n de la tarea y desarrollador
            const taskInfo = await this.getTaskAndDeveloperInfo(changeRequest.task_id, changeRequest.user_id);
            
            const message = this.buildChangeRequestMessage(changeRequest, taskInfo);

            return await this.sendNotification({
                phone: supervisorPhone,
                message,
                taskId: changeRequest.task_id,
                changeRequestId: changeRequest.id,
                type: 'task_change_request'
            });

        } catch (error) {
            logger.error('Error enviando notificaci√≥n de cambio de tarea:', error);
            throw error;
        }
    }

    /**
     * Enviar notificaci√≥n de asignaci√≥n de tarea
     */
    async sendTaskAssignmentNotification(task, developer) {
        try {
            if (!developer.phone) {
                logger.warn(`Desarrollador ${developer.name} no tiene tel√©fono configurado`);
                return { success: false, reason: 'Sin tel√©fono configurado' };
            }

            const message = this.buildAssignmentMessage(task, developer);

            return await this.sendNotification({
                phone: developer.phone,
                message,
                taskId: task.id,
                type: 'task_assignment'
            });

        } catch (error) {
            logger.error('Error enviando notificaci√≥n de asignaci√≥n:', error);
            throw error;
        }
    }

    /**
     * Enviar notificaci√≥n de tarea vencida
     */
    async sendOverdueTaskNotification(task, developer) {
        try {
            if (!developer.phone) {
                return { success: false, reason: 'Sin tel√©fono configurado' };
            }

            const message = this.buildOverdueMessage(task, developer);

            return await this.sendNotification({
                phone: developer.phone,
                message,
                taskId: task.id,
                type: 'task_overdue'
            });

        } catch (error) {
            logger.error('Error enviando notificaci√≥n de tarea vencida:', error);
            throw error;
        }
    }

    /**
     * Guardar notificaci√≥n en la base de datos
     */
    async saveNotification(data) {
        try {
            const {
                taskId,
                changeRequestId,
                recipientPhone,
                message,
                type
            } = data;

            const query = `
                INSERT INTO tablero_whatsapp_notifications (
                    task_id, change_request_id, recipient_phone, 
                    message, type, status, created_at
                ) VALUES (?, ?, ?, ?, ?, 'pending', NOW())
            `;

            const [result] = await pool.execute(query, [
                taskId,
                changeRequestId,
                recipientPhone,
                message,
                type
            ]);

            return result.insertId;

        } catch (error) {
            logger.error('Error guardando notificaci√≥n:', error);
            throw error;
        }
    }

    /**
     * Actualizar estado de notificaci√≥n
     */
    async updateNotificationStatus(notificationId, status) {
        try {
            const query = `
                UPDATE tablero_whatsapp_notifications 
                SET status = ?, sent_at = CASE WHEN ? = 'sent' THEN NOW() ELSE sent_at END
                WHERE id = ?
            `;

            await pool.execute(query, [status, status, notificationId]);

        } catch (error) {
            logger.error('Error actualizando estado de notificaci√≥n:', error);
            throw error;
        }
    }

    /**
     * Obtener tel√©fono del supervisor desde configuraci√≥n
     */
    async getSupervisorPhone() {
        try {
            const query = `
                SELECT setting_value 
                FROM tablero_settings 
                WHERE setting_key = 'supervisor_phone'
            `;

            const [rows] = await pool.execute(query);
            return rows.length > 0 ? rows[0].setting_value : null;

        } catch (error) {
            logger.error('Error obteniendo tel√©fono del supervisor:', error);
            throw error;
        }
    }

    /**
     * Obtener informaci√≥n de tarea y desarrollador
     */
    async getTaskAndDeveloperInfo(taskId, userId) {
        try {
            const query = `
                SELECT 
                    t.title as task_title,
                    t.status as current_status,
                    t.priority,
                    u.name as developer_name
                FROM tablero_tasks t
                JOIN users u ON u.id = ?
                WHERE t.id = ?
            `;

            const [rows] = await pool.execute(query, [userId, taskId]);
            return rows.length > 0 ? rows[0] : null;

        } catch (error) {
            logger.error('Error obteniendo informaci√≥n de tarea y desarrollador:', error);
            throw error;
        }
    }

    /**
     * Construir mensaje para solicitud de cambio
     */
    buildChangeRequestMessage(changeRequest, taskInfo) {
        const priorityEmoji = {
            'very-high': 'üî¥',
            'high': 'üü†',
            'medium': 'üü°',
            'low': 'üü¢'
        };

        const statusEmoji = {
            'backlog': 'üìã',
            'todo': 'üìå',
            'inProgress': '‚ö°',
            'review': 'üëÄ',
            'done': '‚úÖ'
        };

        return `üö® *SOLICITUD DE CAMBIO DE TAREA*

üë§ *Desarrollador:* ${taskInfo.developer_name}
üìù *Tarea:* ${taskInfo.task_title}
${priorityEmoji[taskInfo.priority] || '‚ö™'} *Prioridad:* ${taskInfo.priority.toUpperCase()}

üìä *Estado actual:* ${statusEmoji[changeRequest.from_status]} ${changeRequest.from_status}
üìä *Estado solicitado:* ${statusEmoji[changeRequest.to_status]} ${changeRequest.to_status}

üí¨ *Motivo:*
${changeRequest.reason}

‚è∞ *Fecha solicitud:* ${new Date(changeRequest.requested_at).toLocaleString('es-CO')}

Por favor, revisa y aprueba/rechaza esta solicitud en el sistema del tablero.`;
    }

    /**
     * Construir mensaje para asignaci√≥n de tarea
     */
    buildAssignmentMessage(task, developer) {
        const priorityEmoji = {
            'very-high': 'üî¥',
            'high': 'üü†',
            'medium': 'üü°',
            'low': 'üü¢'
        };

        return `üìã *NUEVA TAREA ASIGNADA*

üëã Hola ${developer.name},

Se te ha asignado una nueva tarea:

üìù *Tarea:* ${task.title}
${priorityEmoji[task.priority] || '‚ö™'} *Prioridad:* ${task.priority.toUpperCase()}
‚è∞ *Estimaci√≥n:* ${task.estimated_hours || 0} horas
üìÖ *Fecha l√≠mite:* ${task.due_date ? new Date(task.due_date).toLocaleDateString('es-CO') : 'No definida'}

${task.description ? `üìÑ *Descripci√≥n:*\n${task.description}` : ''}

¬°Por favor, revisa los detalles en el sistema del tablero!`;
    }

    /**
     * Construir mensaje para tarea vencida
     */
    buildOverdueMessage(task, developer) {
        return `‚ö†Ô∏è *TAREA VENCIDA*

üëã ${developer.name},

La siguiente tarea ha superado su fecha l√≠mite:

üìù *Tarea:* ${task.title}
üìÖ *Fecha l√≠mite:* ${new Date(task.due_date).toLocaleDateString('es-CO')}
üìä *Estado actual:* ${task.status}
üìà *Progreso:* ${task.progress || 0}%

Por favor, actualiza el estado o contacta con tu supervisor.`;
    }

    /**
     * Enviar mensaje por WhatsApp (integraci√≥n real)
     */
    async sendWhatsAppMessage(phone, message) {
        try {
            // Aqu√≠ se integrar√≠a con la API real de WhatsApp
            // Por ejemplo: Twilio, WhatsApp Business API, etc.
            
            // Simulaci√≥n de env√≠o
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // En desarrollo, simplemente log el mensaje
            logger.info(`Simulando env√≠o WhatsApp a ${phone}:`);
            logger.info(message);
            
            // En producci√≥n, reemplazar con c√≥digo real:
            /*
            const response = await fetch('https://api.whatsapp.com/send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${process.env.WHATSAPP_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    to: phone,
                    type: 'text',
                    text: { body: message }
                })
            });
            
            return response.ok;
            */
            
            return true; // Simulaci√≥n exitosa

        } catch (error) {
            logger.error('Error enviando mensaje WhatsApp:', error);
            return false;
        }
    }

    /**
     * Obtener historial de notificaciones
     */
    async getNotificationHistory(filters = {}) {
        try {
            let query = `
                SELECT 
                    n.*,
                    t.title as task_title,
                    cr.reason as change_reason
                FROM tablero_whatsapp_notifications n
                LEFT JOIN tablero_tasks t ON n.task_id = t.id
                LEFT JOIN tablero_task_change_requests cr ON n.change_request_id = cr.id
                WHERE 1=1
            `;

            const params = [];

            if (filters.status) {
                query += ` AND n.status = ?`;
                params.push(filters.status);
            }

            if (filters.type) {
                query += ` AND n.type = ?`;
                params.push(filters.type);
            }

            if (filters.dateFrom) {
                query += ` AND n.created_at >= ?`;
                params.push(filters.dateFrom);
            }

            if (filters.dateTo) {
                query += ` AND n.created_at <= ?`;
                params.push(filters.dateTo);
            }

            query += ` ORDER BY n.created_at DESC LIMIT 100`;

            const [rows] = await pool.execute(query, params);
            return rows;

        } catch (error) {
            logger.error('Error obteniendo historial de notificaciones:', error);
            throw error;
        }
    }

    /**
     * Reenviar notificaci√≥n fallida
     */
    async retryFailedNotification(notificationId) {
        try {
            const query = `
                SELECT * FROM tablero_whatsapp_notifications 
                WHERE id = ? AND status = 'failed'
            `;

            const [rows] = await pool.execute(query, [notificationId]);
            
            if (rows.length === 0) {
                throw new Error('Notificaci√≥n no encontrada o no est√° en estado fallido');
            }

            const notification = rows[0];
            
            const success = await this.sendWhatsAppMessage(
                notification.recipient_phone,
                notification.message
            );

            await this.updateNotificationStatus(
                notificationId,
                success ? 'sent' : 'failed'
            );

            return { success };

        } catch (error) {
            logger.error('Error reenviando notificaci√≥n:', error);
            throw error;
        }
    }
}

export default new WhatsAppNotificationService();
